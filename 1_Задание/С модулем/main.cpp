//Автор: Кузнецов Александр Евгеньевич

#include <iostream>     //Библиотека для ввода-вывода
#include <cmath>        //Библиотека для математических функций
#include "calculator.h" //Подключает модуль с функцией ResAB
#include <cassert>      // для assert 
#include <string>       // для string
#include <windows.h>    // Для SetConsoleCP — настройка кодировки консоли в Windows

using namespace std; //Для упрощения записи

/*
Это стандартная библиотека содержится в пространстве имён std
Чтобы каждый раз не писать std::cout, std::cin и т.д. при образении к содержимому можно использовать using namespace std;
Этой библиотеки сделаю содержимое std доступным непосредственно
*/

// Вспомогательная функция: сравнение двух double с учётом погрешности
// epsilon = 1e-5 — достаточная точность для большинства случаев
bool approx_equal(double a, double b, double epsilon = 1e-5) 
{
    /*
    Проверяет, являются ли два числа a и b почти равными, учитывая погрешность вычислений с плавающей точкой.
    fabs — это функция стандартной библиотеки, которая возвращает абсолютное значение вещественного числа. 
    fabs(a - b): Вычисляет абсолютную разницу между a и b.
    max(fabs(a), fabs(b)): Находит максимальное из абсолютных значений a и b. Учитывает масштаб чисел.
    max(1.0, ...): Гарантирует, что минимальный масштаб не меньше 1.0. Это важно для чисел, близких к нулю. 
    epsilon * ...: Масштабирует epsilon относительно масштаба чисел.
    Если fabs(a - b) <= epsilon * ..., возвращает true (числа почти равны).
    Иначе — false.
    */
    return fabs(a - b) <= epsilon * max(1.0, max(fabs(a), fabs(b)));
}

// Функция автоматического тестирования с assert
namespace testing   // Пространство имён для функции (тестов)
{ 
void run_tests()    //Функция для запуска тестов
{
    cout << "\nЗапуск автоматических тестов с assert...\n"; //Вывод на экран текста

    int total_tests = 0;    //Счетчик всех тестов
    int passed_tests = 0;   //Счетчик пройденных тестов

    // Тест 1: Стандартный случай с положительными числами
    {
        total_tests++;  //Увеличивает счетчик тестов
        cout << "Тест " << total_tests << ": Стандартный случай с положительными числами\n";
        try {           //try это блок кода который может выбросить исключение
            Calc::Result r = Calc::ResAB(4.0, 8.0, 1.0);    //Вызывает функцию вычисления
            cout << "Реальные значения: a = " << r.a << ", b = " << r.b << endl;
            
            // Проверка вычисленных значений с ожидаемыми с помощью assert
            assert(approx_equal(r.a, -0.170718));
            assert(approx_equal(r.b, 3.14524));
            cout << "Тест пройден\n";       //Вывод на экран успеха
            passed_tests++;                 //Увеличивает счетчик пройденных тестов
        } catch (const exception& e) {                                       //catch это блок кода который обрабатывает исключение
            cout << "Ошибка при вычислении: " << e.what() << endl;        //Вывод ошибки
        }
    }

    // Тест 2: Крайний случай — x = 1
    {
        total_tests++;
        cout << "\nТест " << total_tests << ": Крайний случай x = 1\n";
        try {
            Calc::Result r = Calc::ResAB(1.0, 2.0, 2.0);
            cout << "Реальные значения: a = " << r.a << ", b = " << r.b << endl;
            
            // Проверка вычисления для x = 1 с помощью assert
            assert(approx_equal(r.a, -1.51191));
            assert(approx_equal(r.b, 1.12546));
            cout << "Тест пройден\n";
            passed_tests++;
        } catch (const exception& e) {
            cout << "Ошибка при вычислении: " << e.what() << endl;
        }
    }

    // Тест 3: Отрицательное x — проверка модуля под корнем
    {
        total_tests++;
        cout << "\nТест " << total_tests << ": Отрицательное x\n";
        try {
            Calc::Result r = Calc::ResAB(-4.0, 5.0, 3.0);
            cout << "Реальные значения: a = " << r.a << ", b = " << r.b << endl;
            
            // Проверка работы с отрицательными числами с помощью assert
            assert(approx_equal(r.a, -0.189761));
            assert(approx_equal(r.b, -15.8693));
            cout << "Тест пройден\n";
            passed_tests++;
        } catch (const exception& e) {
            cout << "Ошибка при вычислении: " << e.what() << endl;
        }
    }

    // Тест 4: Проверка нулевых значений
    {
        total_tests++;
        cout << "\nТест " << total_tests << ": Нулевые значения\n";
        try {
            Calc::Result r = Calc::ResAB(0.0, 0.0, 0.0);
            cout << "Реальные значения: a = " << r.a << ", b = " << r.b << endl;
            
            // Проверка работы с нулевыми значениями с помощью assert
            assert(approx_equal(r.a, 1.0));
            assert(approx_equal(r.b, 0.0));
            cout << "Тест пройден\n";
            passed_tests++;
        } catch (const exception& e) {
            cout << "Ошибка при вычислении: " << e.what() << endl;
        }
    }

    // Тест 5: Проверка особого случая x = 1, y = 1
    {
        total_tests++;
        cout << "\nТест " << total_tests << ": Особый случай x=1, y=1\n";
        try {
            Calc::Result r = Calc::ResAB(1.0, 1.0, 1.0);
            cout << "Реальные значения: a = " << r.a << ", b = " << r.b << endl;
            
            // Проверка работы с особым случаем с помощью assert
            assert(approx_equal(r.a, -1.71429));
            assert(approx_equal(r.b, 0.803714));
            cout << "Тест пройден\n";
            passed_tests++;
        } catch (const exception& e) {
            cout << "Ошибка при вычислении: " << e.what() << endl;
        }
    }

    // Вывод итоговой статистики
    cout << "\nИТОГИ ТЕСТИРОВАНИЯ\n";
    cout << "Всего тестов: " << total_tests << "\n";    //Вывод общего количества тестов
    cout << "Пройдено: " << passed_tests << "\n";       //Вывод количества пройденных тестов
}
}   // namespace testing конец пространства имен

namespace test = testing; //Создания псевдонима 


// Вывод справки по использованию программы
void show_help() {
    cout << "Использование:" << endl;
    cout << "  ./main.exe [x y z] - вычислить с параметрами x, y, z" << endl;
    cout << "  ./main.exe help    - показать эту справку" << endl;
    cout << "  ./main.exe test    - запустить тесты" << endl;
    cout << "  ./main.exe         - интерактивный режим" << endl;
}


// Нужно делать автоматическо тестов

int main(int argc, char* argv[]) 
{
    // Настраивает локаль для корректного отображения русского текста
    setlocale(LC_ALL, ".UTF-8");     // Устанавливает локаль для всей программы
    SetConsoleCP(CP_UTF8);           // Устанавливает кодировку ввода консоли в UTF-8
    SetConsoleOutputCP(CP_UTF8);     // Устанавливает кодировку вывода консоли в UTF-8

    // Обработка аргументов командной строки
    // argc - количество аргументов (минимум 1 - имя программы)
    // argv - массив строк с аргументами
    if (argc > 1) {
        // Получает первый аргумент (после имени программы)
        string arg1 = argv[1];
        
        // Если пользователь запросил справку
        if (arg1 == "help" || arg1 == "--help" || arg1 == "-h") {
            show_help();    // Показывает инструкцию по использованию
            return 0;       // Завершает программу
        }
        // Если пользователь хочет запустить тесты
        else if (arg1 == "test") {
            test::run_tests();  // Запускает все тесты
            return 0;           // Завершает программу
        }
        // Если передано 3 числовых параметра (всего 4 аргумента с именем программы)
        else if (argc == 4) {
            // Режим с аргументами командной строки
            try {
                // Преобразует строковые аргументы в числа типа double
                double x = stod(argv[1]);  // Первый параметр -> x
                double y = stod(argv[2]);  // Второй параметр -> y  
                double z = stod(argv[3]);  // Третий параметр -> z
                
                // Вызывает функцию вычисления с переданными параметрами
                Calc::Result res = Calc::ResAB(x, y, z);
                
                // Выводит результаты вычислений
                cout << "a = " << res.a << endl;
                cout << "b = " << res.b << endl;
                
                return 0;  // Успешное завершение
            }
            catch (const exception& e) {
                // Обрабатывает ошибки преобразования строк в числа
                cerr << "Ошибка в аргументах: " << e.what() << endl;
                cerr << "Убедитесь, что все параметры - числа" << endl;
                return 1;  // Завершение с ошибкой
            }
        }
        // Если аргументы переданы, но их количество не совпадает с ожидаемым
        else {
            cerr << "Неверное количество аргументов!" << endl;
            cerr << "Используйте: ./main.exe x y z" << endl;
            cerr << "Или: ./main.exe help - для справки" << endl;
            return 1;
        }
    }

    test::run_tests();

    //Блок выбора режима работы
    cout << endl;
    cout << "Выберите вариант:\n " << endl; //Вывод на экран
    cout << "1. Вычислить результат\n";     //Вывод на экран
    cout << "2. Запустить тесты\n";         //Вывод на экран
    cout << "Ваш выбор (1 или 2): ";        //Вывод на экран

    int choice;    //Переменная для выбора режима работы
    cin >> choice; //Ввод данных с клавиатуры

    if (choice == 1)  //Если выбран первый режим
    {
        // Основной режим
        double x, y, z; //переменные типа double, double - тип данных с плавающей точкой
        cout << "Введите x, y, z: "; //Вывод на экран
        cin >> x >> y >> z;          //Ввод данных с клавиатуры

        try  //try это блок кода который может выбросить исключение
        {
            Calc::Result res = Calc::ResAB(x, y, z);     //Вызов функции ResAB через пространства имен
            cout << "a = " << res.a << endl;             //Вывод на экран
            cout << "b = " << res.b << endl;             //Вывод на экран
        }
        catch (const exception& e)    //catch это блок кода который обрабатывает исключение
                                      //exception& e — ссылка на исключение
        {
            cerr << "Ошибка: " << e.what() << endl;     //Вывод на экран текста ошибки
            return 1;                                   //Возврат значения 1
        }
        return 0;                                       //Возврат значения 0

    }
    else if (choice == 2) //Если выбран второй режим
    {
        // Запуск тестов 
        try                     //try это блок кода который может выбросить исключение
        {
            test::run_tests();  //Вызов функции через пространство имён
        } catch (...)           //catch это блок кода который обрабатывает исключение
        {
            cerr << "Тесты завершились с ошибкой!" << endl;  //Вывод на экран текста ошибки
            return 1;                                        //Возврат значения 1
        }
        return 0; //Возврат значения 0
    }
    else  //Если выбрано что-то другое
    {
        cerr << "Неверный выбор. Запустите программу снова." << endl; //Вывод на экран текста ошибки
        return 1; //Возврат значения 1
    }
}   //Конец блока выбора режима работы