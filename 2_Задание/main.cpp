// main.cpp - главный файл программы

//Автор: Кузнецов Александр Евгеньевич

/** 
 *      Задание:
 *              Дана последовательность a[1..n]. Вычислить:
 *              и) а1 / 0! + a2 / 1! + ... + an / (n-1)!
 *
 * 
 */


//Стандартная библиотека
#include <iostream>        // Для ввода-вывода: cout, cin
#include <cassert>         // Для макроса assert (тестирование)
#include <cmath>           // Для математических функций: fabs
#include <vector>          // Для контейнера vector
#include <cstdlib>         // Для функций rand(), srand()
#include <ctime>           // Для функции time()
#include "Mass.h"          // Заголовочный файл для работы с массивами
#include "VectorModule.h"  // Заголовочный файл для работы с векторами


#define WIN32_LEAN_AND_MEAN // Исключить редко используемые API Windows
#define NOMINMAX            // Предотвратить определение min/max в windows.h
#include <windows.h>        // Для SetConsoleCP — настройка кодировки консоли в Windows
 
/*

Обработка исключений В C++:
try    - блок кода, в котором могут возникнуть исключения
catch  - блок, который обрабатывает конкретный тип исключения  
throw  - оператор для генерации исключения

Принцип работы:
1. Код в try-блоке выполняется нормально
2. Если возникает ошибка, генерируется исключение (throw)
3. Выполнение переходит в соответствующий catch-блок
4. Программа продолжает работу или завершается корректно

*/

using namespace std; // Использование пространства имен std для упрощения кода

// Вспомогательная функция: сравнение двух double с учётом погрешности
// epsilon = 1e-9 — достаточная точность для большинства случаев
/*
Параметры:
double a, double b - числа для сравнения
double epsilon = 1e-9 - допустимая погрешность (по умолчанию 0.000000001)
Возвращает: true если числа равны с учетом погрешности, иначе false

Алгоритм:
1. Вычисляет абсолютную разницу между a и b
2. Масштабирует погрешность относительно величины чисел
3. Сравнивает разницу с масштабированной погрешностью

*/

bool approx_equal(double a, double b, double epsilon = 1e-9) {
    return fabs(a - b) <= epsilon * max(1.0, max(fabs(a), fabs(b)));
}

// Функция автоматического тестирования
// Цель: проверить корректность работы функции SumFactorialDiv
void run_tests()
{
    cout << "Запуск автоматических тестов...\n";
    
    // Тест 1: Проверка формулы a1/0! + a2/1! + ... + an/(n-1)!
    // Массив: [1.0, 2.0, 3.0]
    // Расчет: 1/0! + 2/1! + 3/2! = 1/1 + 2/1 + 3/2 = 1 + 2 + 1.5 = 4.5
    {
        double testArr[] = {1.0, 2.0, 3.0};                 // Тестовый массив
        double result = Mass::SumFactorialDiv(testArr, 3);  // Вызов тестируемой функции
        assert(approx_equal(result, 4.5));                 // Проверка результата
        cout << "Тест 1 пройден: сумма по формуле a_i / (i-1)!\n";
    }

    // Тест 2: Проверка одного элемента в массиве
    // Массив: [5.0]
    // Расчет: 5/0! = 5/1 = 5
    {   
        double testArr[] = {5.0};                           // Массив с одним элементом
        double result = Mass::SumFactorialDiv(testArr, 1); 
        assert(approx_equal(result, 5.0));
        cout << "Тест 2 пройден: один элемент в массиве\n";
    }
    
    // Тест 3: Проверка пустого массива
    // Ожидается: 0.0
    {   
        double result = Mass::SumFactorialDiv(nullptr, 0); // Передача nullptr и размера 0
        assert(approx_equal(result, 0.0)); 
        cout << "Тест 3 пройден: пустой массив\n";
    }
    
    // Тест 4: Проверка отрицательных чисел
    // Массив: [-1.0, -2.0]
    //  Расчет: -1/0! + 2/1! = -1/1 + 2/1 = -1 + 2 = 1
    {
        double testArr[] = {-1.0, -2.0};                       // Массив с отрицательными числами
        double result = Mass::SumFactorialDiv(testArr, 2);
        assert(approx_equal(result, -3.0));
        cout << "Тест 4 пройден: отрицательные числа\n";
    }

    cout << "Все тесты пройдены успешно!\n";
}

// Главная функция программы
// Точка входа в приложение
int main() 
{
    // Настраивает локаль для корректного отображения русского текста
    setlocale(LC_ALL, ".UTF-8");     // Устанавливает локаль для всей программы
    SetConsoleCP(CP_UTF8);           // Устанавливает кодировку ввода консоли в UTF-8
    SetConsoleOutputCP(CP_UTF8);     // Устанавливает кодировку вывода консоли в UTF-8

    try // Начало блока обработки исключений
    {
        // Инициализация генератора случайных чисел
        // time(nullptr) возвращает текущее время в секундах
        // static_cast<unsigned int> преобразует время в беззнаковое целое
        // srand() устанавливает это значение как seed для генератора
        srand(static_cast<unsigned int>(time(nullptr)));
            
        // Запуск автоматических тестов
        run_tests();
        cout << "\n";

        // Меню выбора способа создания массива
        cout << "Выберите способ создания массива:\n";
        cout << "1. Ввести вручную с клавиатуры\n";
        cout << "2. Заполнить случайными числами\n";
        cout << "3. Загрузить из текстового файла\n";
        cout << "4. Загрузить из бинарного файла\n";

        int sourceChoice; // Переменная для хранения выбора пользователя
        cin >> sourceChoice;
        
        // Проверка корректности ввода
        if (cin.fail())
        {
            throw invalid_argument("Неверный ввод выбора\n");
        }

        double* arr = nullptr; // Указатель на динамический массив (изначально пустой)
        int n = 0;             // Размер массива (изначально 0)

        // Обработка выбора пользователя
        if (sourceChoice == 1 || sourceChoice == 2) {
            // Для ручного ввода или случайного заполнения запрашиваем размер
            cout << "Введите размер массива n: ";
            cin >> n;
            
            // Проверка корректности размера
            if (cin.fail() || n <= 0) 
            {
                throw invalid_argument("Размер должен быть натуральным числом\n");
            }
            
            // Выделение памяти под массив
            arr = new double[n];

            if (sourceChoice == 1) 
            {
                // Ручной ввод элементов
                cout << "Введите " << n << " чисел:\n";
                for (int i = 0; i < n; ++i) 
                {
                    cin >> arr[i];
                    if (cin.fail()) 
                    {
                        throw invalid_argument("Ошибка ввода числа.");
                    }  
                } 
            }
            else 
            {
                // Заполнение случайными числами
                Mass::fillRandom(arr, n);
            }
        }
        else if (sourceChoice == 3)
        {
            // Загрузка из текстового файла
            arr = fileSL::loadFileText(n, "array.txt"); 
        }
        else if (sourceChoice == 4) 
        {
            // Загрузка из бинарного файла
            arr = fileSL::loadFileBin(n, "array.bin"); 
        }
        else
        {
            throw invalid_argument("Неверный выбор\n");
        }

        // Вывод массива на экран
        cout << "Массив из " << n << " элементов:\n";
        Mass::printArray(arr, n);

        // Вычисление суммы a1/0! + a2/1! + ... + an/(n-1)!
        double sumFact = Mass::SumFactorialDiv(arr, n);
        cout << "\nСумма a1/0! + a2/1! + ... + an/(n-1)!: " << sumFact << endl;

        // Меню сохранения массива
        cout << "\nСохранить массив в файл?\n";
        cout << "1. Текстовый файл\n";
        cout << "2. Бинарный файл\n";
        cout << "3. Не сохранять\n";
        
        int saveChoice;
        cin >> saveChoice;

        if (saveChoice == 1) 
        {
            fileSL::saveFileText(arr, n, "array.txt");
        } 
        else if (saveChoice == 2) 
        {
            fileSL::saveFileBin(arr, n, "array.bin");
        }

        // Работа с векторами
        cout << "\n";
        cout << "Решение с использованием vector\n";

        // Создание вектора того же размера
        vector<double> vec(n);

        // Заполнение вектора случайными числами
        VecMath::fillRandom(vec);

        // Вывод вектора
        cout << "Вектор из " << n << " элементов:\n";
        VecMath::printArray(vec);

        // Вычисление суммы a1/0! + a2/1! + ... + an/(n-1)! для вектора
        double sumVec = VecMath::sumFactorialDiv(vec);
        cout << "\nСумма a1/0! + a2/1! + ... + an/(n-1)! найдена вектором: " << sumVec << endl;

        // Освобождение динамической памяти
        delete[] arr;
        return 0; // Успешное завершение программы
    }
    // Блкои обработки исключений:
    catch (const bad_alloc& e) {
        // Ошибка выделения памяти
        cerr << "Ошибка памяти: не удалось выделить память под массив.\n";
    }
    catch (const invalid_argument& e) {
        // Ошибка неверных аргументов
        cerr << "Ошибка ввода: " << e.what() << "\n";
    }
    catch (const runtime_error& e) {
        // Ошибка времени выполнения
        cerr << "Ошибка выполнения: " << e.what() << "\n";
    }
    catch (const exception& e) {
        // Любое другое стандартное исключение
        cerr << "Неизвестная ошибка: " << e.what() << "\n";
    }
    catch (...) {
        // Необработанное исключение любого типа
        cerr << "Критическая ошибка: произошло нечто неожиданное.\n";
    }

    return 1; // Завершение с ошибкой
}